<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<input type="text" id="search-bar" style="display: block"/>

<pre id="highlight-bar"></pre>

<script type="application/javascript">
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/<mark>/g, "(((")
            .replace(/<\/mark>/g, ")))")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;")
            .replace(/\(\(\(/gi, "<mark>")
            .replace(/\)\)\)/gi, "</mark>");
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    let timeout = 0;
    let abort = new AbortController();
    let signal = abort.signal;

    let curcounter = 0;
    let latency = 100;

    const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

    const SURROUNDING = 100;

    async function handle_request(str) {
        if (str.trim() === "") return;

        str = str.replace(/ /g, '+');

        curcounter++;
        let mycounter = curcounter;
        abort.abort();
        abort = new AbortController();
        signal = abort.signal;

        await sleep(50);
        if (signal.aborted || mycounter !== curcounter) return;

        let resp = await fetch("/search/?q=" + str, {signal});
        console.log("Response time: ", resp.headers.get("Server-Timing"), "ms")
        let text = await resp.json();
        text = text.flat();

        text.sort((a, b) => {
            return a.df - b.df;
        });
        text.reverse();


        let htmltext = "";
        for(const c of text) {
            c.fn = decodeURIComponent(c.fn);
            c.fn = "http://instructables.com" + c.fn;
            htmltext += `<a href="${c.fn}">${c.fn} Score: ${c.df}</a></br>`;
        }

        if (signal.aborted || mycounter !== curcounter) return;

        document.getElementById("highlight-bar").innerHTML = htmltext;

        // // If latency is high, we want to minimize calls to highlight. If latency is low, we can call highlight freely.
        // await sleep(500);
        //
        // if (signal.aborted || mycounter !== curcounter) return;
        //
        // let highlight = await fetch("/highlight/?id=" + id, {signal});
        // highlight = await highlight.json();
        //
        //
        // for (v of highlight) {
        //
        //
        //     let prevm = -1e5;
        //     let curstring = "";
        //     for (const m of v.matches) {
        //         let start, end;
        //         let skipped;
        //         if (m[0] - prevm > SURROUNDING) {
        //             start = m[0] - SURROUNDING;
        //             skipped = true;
        //         } else {
        //             start = prevm;
        //             skipped = false;
        //         }
        //         end = m[1] + SURROUNDING;
        //         prevm = end;
        //
        //         start = clamp(start, 0, v.document.length);
        //         end = clamp(end, 0, v.document.length);
        //
        //         if (skipped) curstring += "...";
        //
        //         curstring += v.document.substring(start, m[0]);
        //         curstring += "<mark>";
        //         curstring += v.document.substring(m[0], m[1]);
        //         curstring += "</mark>";
        //         curstring += v.document.substring(m[1], end);
        //     }
        //     // v.document = curstring;
        //     delete v.matches;
        //     v.document = v.document.replace(/\\n/gi, "");
        //     v.document = escapeHtml(v.document);
        //
        //     // highlight[v][1].document = escapeHtml(highlight[v][1].document);
        //     // highlight[v].document = highlight[v].document.replace(/\n/gi, "");
        //     // newresp = newresp.
        //     // newresp = newresp.
        //     // highlight[v][hg] = newresp;
        // }
        // window.dev = highlight;

        // document.getElementById('highlight-bar').innerHTML = JSON.stringify(highlight, null, 3);
    }

    document.getElementById("search-bar").addEventListener("input", (ev) => {
        handle_request(ev.target.value).then(() => undefined);
    })
</script>
</body>
</html>
