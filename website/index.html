<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<input type="text" id="search-bar" style="display: block"/>

<pre id="highlight-bar"></pre>

<script type="application/javascript">
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    let timeout = 0;
    let abort = new AbortController();
    let signal = abort.signal;


    async function handle_request(str) {
        abort.abort();
        abort = new AbortController();
        signal = abort.signal;
        let resp = await fetch("/search/?q=" + str, {signal});
        let text = await resp.json();

        if (signal.aborted) return;

        formattedtext = JSON.stringify(text.data, null, 3);
        id = text.id;
        document.getElementById("highlight-bar").innerHTML = formattedtext;

        let highlight = await fetch("/highlight/?id=" + id, {signal});
        highlight = await highlight.json();

        if (signal.aborted) return;


        for (v in highlight) {
            for (hg in highlight[v]) {
                let newresp = highlight[v][hg].replace(/(<([^>]+)>)/gi, "");
                newresp = newresp.replace(/\(\(\(/gi, "<mark>");
                newresp = newresp.replace(/\)\)\)/gi, "</mark>");
                highlight[v][hg] = newresp;
            }
        }

        document.getElementById('highlight-bar').innerHTML = JSON.stringify(highlight, null, 3);
    }

    document.getElementById("search-bar").addEventListener("input", (ev) => {
        handle_request(ev.target.value).then(() => console.log("done"));
    })
</script>
</body>
</html>